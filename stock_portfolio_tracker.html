<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' https://cdn.jsdelivr.net 'nonce-random-nonce-value-for-security-1234567890123456789'; 
                   style-src 'self' 'unsafe-inline'; 
                   img-src 'self' https://via.placeholder.com data:; 
                   connect-src 'self';
                   font-src 'self'; 
                   object-src 'none';
                   base-uri 'self';
                   form-action 'self';
                   frame-ancestors 'none';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script> 
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .auth-buttons { text-align: right; margin-bottom: 20px; display:flex; justify-content: flex-end; align-items:center; }
        .auth-buttons button, .auth-buttons a { margin-left: 10px; padding: 8px 15px; background-color: #1877f2; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
        .auth-buttons button:hover, .auth-buttons a:hover { background-color: #166fe5; }
        #logoutButton { background-color: #e4e6eb; color: #050505; }
        #logoutButton:hover { background-color: #d8dadf; }
        #adminDashboardLink, #viewPlansButton { background-color: #6c757d; color: white; }
        #adminDashboardLink:hover, #viewPlansButton:hover { background-color: #5a6268; }
        #trialInfo { margin-right: 15px; font-size: 13px; color: #e67e22; }


        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #ddd; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .admin-modal-content { max-width: 700px; } 
        .dividend-modal-content { max-width: 600px; } 
        .subscription-modal-content { max-width: 800px; }
        .generic-import-modal-content { max-width: 750px; } 
        .payment-modal-content { max-width: 600px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; }
        
        .notification { padding: 12px 15px; margin-bottom: 20px; border-radius: 6px; font-size: 14px; }
        .notification.success { background-color: #e6fffa; color: #006400; border: 1px solid #b3ffe6; }
        .notification.error { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .notification.info { background-color: #e7f3fe; color: #0d6efd; border: 1px solid #cfe2ff;}
        .notification ul { margin-top: 5px; padding-left: 20px; }


        h1, h2 { color: #050505; }
        h1 { text-align: center; margin-bottom: 30px; }
        h2 { margin-top: 0; font-size: 20px; }
        h3 {font-size: 18px; margin-bottom: 10px;}
        
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="file"], select, textarea { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        textarea { font-family: monospace; min-height: 150px; }
        form button { width: 100%; padding: 12px; background-color: #1877f2; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        form button:hover { background-color: #166fe5; }
        form p { font-size: 12px; text-align: center; margin-top: 15px; }
        form p a { color: #1877f2; text-decoration: none; }
        form p a:hover { text-decoration: underline; }

        .summary-cards { display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap; }
        .card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-basis: calc(25% - 20px); margin: 10px; text-align: center; border: 1px solid #e4e6eb; }
        .card h3 { margin-top: 0; font-size: 14px; color: #606770; }
        .card p { font-size: 20px; font-weight: bold; color: #050505; margin-bottom: 0; }
        .positive { color: #42b72a !important; }
        .negative { color: #fa383e !important; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; font-size: 14px; }
        th { background-color: #f7f7f7; font-weight: 600; color: #333; }
        tr:hover { background-color: #f5f5f5; }
        td .action-button { padding: 5px 10px; border:none; border-radius:4px; cursor:pointer; color:white; margin-right: 5px; font-size: 12px;}
        .edit-button { background-color: #1877f2; } 
        .delete-button { background-color: #fa383e; } 
        .dividend-button { background-color: #28a745; } 


        .filter-controls { margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; }
        .filter-controls input[type="text"] { width: auto; flex-grow: 1; margin-right: 10px; max-width: 300px; }
        .filter-controls .letter-filters button { margin: 2px; padding: 5px 10px; font-size: 12px; background-color: #e4e6eb; border: 1px solid #ccc; border-radius:4px; cursor:pointer;}
        .filter-controls .letter-filters button.active { background-color: #1877f2; color:white; border-color: #1877f2;}
        .filter-controls button.clear-filter { padding: 10px 12px; background-color: #6c757d; color:white; font-size: 12px; }
        
        .action-buttons-group { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        .action-buttons-group button, .action-buttons-group label { padding: 10px 15px; background-color: #42b72a; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
        .action-buttons-group input[type="file"] { display: none; } 
        .action-buttons-group label[for="csvFileInput"] { background-color: #007bff; }
        #jsonImportButton { background-color: #17a2b8; } 


        /* Chart Containers */
        .chart-container-wrapper { padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e4e6eb; margin-bottom: 30px; }
        .chart-container-wrapper h2 { text-align: center; margin-bottom: 10px;}
        .chart-period-selector { text-align: center; margin-bottom: 15px; }
        .chart-period-selector button { padding: 5px 10px; margin: 0 5px; font-size: 12px; background-color: #e4e6eb; border: 1px solid #ccc; border-radius:4px; cursor:pointer;}
        .chart-period-selector button.active { background-color: #1877f2; color:white; border-color: #1877f2;}
        .echart-instance { width: 100%; height: 400px; } 


        #stockDashboard { display: none; } 

        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e4e6eb; }
        .chart-card h3 { text-align: center; margin-bottom: 15px; font-size: 16px; color: #333; }
        .chart-placeholder { height: 300px; display: flex; align-items: center; justify-content: center; color: #aaa; }


        /* News Section Styles */
        #newsSection { margin-top: 30px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e4e6eb; margin-bottom: 30px;}
        #newsSection h2 { margin-bottom: 15px; }
        .news-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .news-item:last-child { border-bottom: none; }
        .news-item-header { display: flex; align-items: center; margin-bottom: 8px;}
        .news-item-banner { width: 80px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .news-item-title { font-size: 16px; font-weight: 600; color: #050505; text-decoration: none; }
        .news-item-title:hover { text-decoration: underline; color: #1877f2; }
        .news-item-meta { font-size: 12px; color: #606770; margin-bottom: 5px; }
        .news-item-summary { font-size: 14px; color: #1c1e21; line-height: 1.5; }

        /* Price Alerts Section */
        #alertsSection { margin-top: 30px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e4e6eb; margin-bottom: 30px;}
        #alertsSection h2 { margin-bottom: 15px; }
        #addAlertForm { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap;}
        #addAlertForm input, #addAlertForm select { margin-bottom: 0; width: auto; flex-grow:1; }
        #addAlertForm button { width: auto; flex-grow:0; padding: 12px 15px;}
        .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px;}
        .alert-item:last-child { border-bottom: none; }
        .alert-item span { flex-grow: 1; }
        .alert-item .delete-alert-btn { background-color: #fa383e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;}
        
        /* Dividend Management Modal Specifics */
        #dividendListContainer { max-height: 200px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;}
        .dividend-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 14px;}
        .dividend-list-item:not(:last-child) { border-bottom: 1px dashed #f0f0f0; }
        .dividend-list-item .actions button { margin-left: 8px; font-size: 12px; padding: 3px 7px;}
        #addDividendForm { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;}
        #addDividendForm input, #addDividendForm button { margin-bottom: 0; }
        #addDividendForm input[type="number"], #addDividendForm input[type="date"] { flex-grow: 1;}
        #addDividendForm button { flex-grow: 0.5; }

        /* Subscription Plans Modal */
        .subscription-plans-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .plan-card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; width: 200px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .plan-card h3 { font-size: 1.5em; margin-bottom: 10px; color: #1877f2; }
        .plan-card .price { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
        .plan-card ul { list-style: none; padding: 0; margin-bottom: 20px; text-align: left; font-size: 0.9em; }
        .plan-card ul li { margin-bottom: 8px; position: relative; padding-left: 20px; }
        .plan-card ul li::before { content: '✓'; color: #28a745; position: absolute; left: 0; }
        .plan-card ul li.not-included::before { content: '✗'; color: #dc3545; }
        .plan-card button { background-color: #28a745; width: auto; padding: 10px 20px; }

        /* Generic JSON Import Modal */
        #jsonImportInstructions { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; border-radius: 4px; font-size: 0.85em; max-height: 150px; overflow-y: auto; margin-top:10px; margin-bottom: 15px;}
        #jsonImportInstructions code { white-space: pre-wrap; }
        .import-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .import-section h3 { font-size: 1.1em; margin-bottom:10px; color: #333; }
        
        /* Payment Method Modal & Crypto Payment Info */
        #paymentMethodModal .payment-options button { display: block; width: calc(100% - 24px); margin: 10px auto; padding: 12px; font-size: 1em; }
        #cryptoPaymentInfo { margin-top: 15px; padding:10px; border: 1px solid #eee; border-radius: 4px;}
        #cryptoPaymentInfo p { margin: 5px 0; }
        #cryptoPaymentInfo strong { color: #333; }
        #cryptoPaymentInfo code { background-color: #f0f0f0; padding: 2px 5px; border-radius: 3px; }
        #transactionIdForm { margin-top: 15px; }
        #transactionIdForm label { display:block; margin-bottom: 5px; }

        .text-xs { font-size: 0.75rem; } 
        .text-gray-500 { color: #6b7280; } 
        .text-center { text-align: center; }

        /* Admin Dashboard Modal Specifics */
        #adminDashboardModal .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;}
        #adminDashboardModal .stat-item { background-color: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef;}
        #adminDashboardModal .stat-item h4 { margin-top: 0; margin-bottom: 5px; font-size: 14px; color: #495057;}
        #adminDashboardModal .stat-item p { font-size: 18px; font-weight: bold; color: #212529; margin-bottom: 0;}
        #adminDashboardModal h3 { font-size: 16px; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #adminPendingPaymentsContainer { max-height: 250px; overflow-y: auto; }
        #adminPendingPaymentsContainer table { font-size: 0.9em; }
        #adminPendingPaymentsContainer th, #adminPendingPaymentsContainer td { padding: 8px; }


    </style>
</head>
<body>

<div class="container">
    <h1>Stock Portfolio Tracker</h1>
    <div class="auth-buttons">
        <span id="trialInfo" style="display:none;"></span> 
        <button id="viewPlansButton" onclick="openSubscriptionPlansModal()" style="display:none;">View Plans</button>
        <a href="#" id="adminDashboardLink" onclick="openAdminDashboard()" style="display:none;">Admin</a>
        <button id="loginNavButton" onclick="openLoginModal()">Login</button>
        <button id="signupNavButton" onclick="openSignupModal()">Sign Up</button>
        <button id="logoutButton" style="display:none;" onclick="handleLogout()">Logout</button>
    </div>

    <div id="notificationArea"></div>

    <div id="stockDashboard">
        <div class="summary-cards">
            <div class="card"><h3>Total Portfolio Value</h3><p id="totalPortfolioValue">$0.00</p></div>
            <div class="card"><h3>Total Return</h3><p id="totalReturn">$0.00</p></div>
            <div class="card"><h3>Total Dividends Received</h3><p id="totalDividendsReceived">$0.00</p></div> 
            <div class="card"><h3>Day's Gain/Loss</h3><p id="daysGainLoss">N/A</p></div> 
        </div>

        <h2>My Stock Holdings</h2>
        <div class="filter-controls">
            <input type="text" id="stockSearchInput" placeholder="Search by symbol...">
            <div class="letter-filters" id="letterFiltersContainer">
                <!-- Letter buttons will be generated here -->
            </div>
            <button id="clearFiltersButton" class="clear-filter" title="Clear all filters">Clear</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Shares</th>
                    <th>Purchase Price</th>
                    <th>Category</th> 
                    <th>Current Price</th>
                    <th>Change %</th>
                    <th>Market Value</th>
                    <th>Total Dividends</th> 
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="stockTableBody">
                <!-- Stock rows will be inserted here -->
            </tbody>
        </table>
        
        <div class="action-buttons-group">
            <button onclick="openAddStockModal()" id="addStockButton">Add Stock</button>
            <label for="csvFileInput" id="importCSVButton">Import CSV</label>
            <input type="file" id="csvFileInput" accept=".csv" onchange="handleImportCSV(this)">
            <button id="jsonImportButton" onclick="openGenericImportModal()">Import Portfolio (JSON)</button> 
        </div>

        <div class="chart-container-wrapper">
            <h2>Portfolio Performance vs Benchmark (SPY)</h2>
            <div class="chart-period-selector" id="performancePeriodSelector">
                <button data-period="1M" class="active">1M</button>
                <button data-period="6M">6M</button>
                <button data-period="1Y">1Y</button>
                <button data-period="ALL">ALL</button>
            </div>
            <div id="portfolioPerformanceChart" class="echart-instance chart-placeholder">Performance data loading...</div>
        </div>


        <div class="charts-grid">
            <div class="chart-card">
                <h3>Portfolio Allocation</h3>
                <div id="allocationChart" class="echart-instance chart-placeholder">Allocation data loading...</div>
            </div>
            <div class="chart-card">
                <h3>Sector Analysis</h3>
                <div id="sectorAnalysisChart" class="echart-instance chart-placeholder">Sector data loading...</div>
            </div>
            <div class="chart-card">
                <h3>Dividend History</h3>
                <div id="dividendChart" class="echart-instance chart-placeholder"></div>
                <p class="text-xs text-gray-500 text-center">Dividend tracking coming soon!</p>
            </div>
        </div>


        <div id="newsSection">
            <h2>Latest Financial News</h2>
            <div id="newsContainer">
                <!-- News items will be inserted here -->
            </div>
        </div>

        <div id="alertsSection">
            <h2>Price Alerts</h2>
            <form id="addAlertForm" onsubmit="handleAddAlert(event)">
                <input type="text" id="alertSymbol" placeholder="Symbol (e.g., AAPL)" required>
                <select id="alertCondition" required>
                    <option value="above">Price Above</option>
                    <option value="below">Price Below</option>
                </select>
                <input type="number" id="alertTargetPrice" placeholder="Target Price" required step="0.01" min="0.01">
                <button type="submit">Add Alert</button>
            </form>
            <div id="alertsContainer">
                <!-- Active alerts will be displayed here -->
            </div>
        </div>

    </div> <!-- End of stockDashboard -->
</div>

<!-- Add Stock Modal -->
<div id="addStockModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeAddStockModal()">&times;</span>
        <h2>Add New Stock</h2>
        <form id="addStockForm" onsubmit="handleAddStock(event)">
            <input type="text" id="addStockSymbol" placeholder="Stock Symbol (e.g., AAPL)" required>
            <input type="number" id="addStockShares" placeholder="Number of Shares" required step="1" min="1">
            <input type="number" id="addStockPurchasePrice" placeholder="Purchase Price per Share" required step="0.01" min="0.01">
            <input type="date" id="addStockPurchaseDate" placeholder="Purchase Date">
            <input type="text" id="addCustomCategory" placeholder="Custom Category (e.g., Growth, Dividend)"> 
            <button type="submit">Add Stock</button>
        </form>
    </div>
</div>

<!-- Edit Stock Modal -->
<div id="editStockModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditStockModal()">&times;</span>
        <h2>Edit Stock Holding</h2>
        <form id="editStockForm" onsubmit="handleEditStock(event)">
            <input type="hidden" id="editStockId">
            <div>
                <label for="editStockSymbolView">Symbol</label>
                <input type="text" id="editStockSymbolView" placeholder="Stock Symbol" readonly style="background-color: #eee;">
            </div>
            <div>
                <label for="editStockShares">Shares</label>
                <input type="number" id="editStockShares" placeholder="Number of Shares" required step="1" min="1">
            </div>
            <div>
                <label for="editStockPurchasePrice">Purchase Price per Share</label>
                <input type="number" id="editStockPurchasePrice" placeholder="Purchase Price per Share" required step="0.01" min="0.01">
            </div>
            <div>
                <label for="editStockPurchaseDate">Purchase Date</label>
                <input type="date" id="editStockPurchaseDate">
            </div>
            <div>
                <label for="editCustomCategory">Custom Category</label> 
                <input type="text" id="editCustomCategory" placeholder="Custom Category (e.g., Growth, Dividend)">
            </div>
            <button type="submit">Save Changes</button>
        </form>
    </div>
</div>

<!-- Dividend Management Modal -->
<div id="dividendManagerModal" class="modal">
    <div class="modal-content dividend-modal-content">
        <span class="close-button" onclick="closeDividendManagerModal()">&times;</span>
        <h2 id="dividendManagerTitle">Manage Dividends for [Stock Symbol]</h2>
        
        <h3>Add New Dividend</h3>
        <form id="addDividendForm" onsubmit="handleAddDividend(event)">
            <input type="hidden" id="dividendStockId">
            <input type="number" id="dividendAmount" placeholder="Amount Received" required step="0.01" min="0.01">
            <input type="date" id="dividendPayDate" required>
            <button type="submit">Add Dividend</button>
        </form>
        
        <h3>Recorded Dividends</h3>
        <div id="dividendListContainer">
            <p>No dividends recorded yet for this stock.</p>
        </div>
    </div>
</div>

<!-- Edit Dividend Modal -->
<div id="editDividendModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditDividendModal()">&times;</span>
        <h2>Edit Dividend Payment</h2>
        <form id="editDividendForm" onsubmit="handleEditDividend(event)">
            <input type="hidden" id="editDividendId">
            <input type="hidden" id="editDividendStockId"> 
            <div>
                <label for="editDividendAmount">Amount Received</label>
                <input type="number" id="editDividendAmount" required step="0.01" min="0.01">
            </div>
            <div>
                <label for="editDividendPayDate">Payment Date</label>
                <input type="date" id="editDividendPayDate" required>
            </div>
            <button type="submit">Save Changes</button>
        </form>
    </div>
</div>

<!-- Subscription Plans Modal -->
<div id="subscriptionPlansModal" class="modal">
    <div class="modal-content subscription-modal-content">
        <span class="close-button" onclick="closeSubscriptionPlansModal()">&times;</span>
        <h2>Subscription Plans</h2>
        <div id="subscriptionPlansContainer" class="subscription-plans-container">
            <p>Loading plans...</p>
        </div>
        <div id="paymentMethodSelection" style="display:none; margin-top: 20px; padding-top:20px; border-top: 1px solid #eee;">
             <h3>Select Payment Method for <span id="selectedPlanName"></span> Plan</h3>
             <div class="payment-options">
                <button onclick="initiateCryptoPaymentFlow()">Pay with Crypto (USDT-TRC20)</button>
                <!-- Add other payment method buttons here when available -->
             </div>
        </div>
        <p style="text-align:center; margin-top:20px;">Payment integration coming soon! For now, crypto payment is illustrative.</p>
    </div>
</div>

<!-- Crypto Payment Modal (or part of PaymentMethodModal) -->
<div id="cryptoPaymentModal" class="modal">
    <div class="modal-content payment-modal-content">
        <span class="close-button" onclick="closeCryptoPaymentModal()">&times;</span>
        <h2 id="cryptoPaymentTitle">Pay for [Plan Name] with Crypto</h2>
        <div id="cryptoPaymentInstructions">
            <p>Please send <strong id="cryptoAmountExpected"></strong> <span id="cryptoTypeDisplay">USDT</span> to the following address:</p>
            <p>Address: <code id="cryptoReceivingAddress"></code></p>
            <p>Network: <span id="cryptoNetworkDisplay">TRC-20 (Tron)</span></p>
            <p style="color:red; font-weight:bold;">IMPORTANT: After sending, paste your Transaction ID below and click 'Confirm Payment'.</p>
        </div>
        <form id="transactionIdForm" onsubmit="handleTransactionIdSubmit(event)">
            <input type="hidden" id="cryptoPaymentId">
            <label for="transactionIdInput">Transaction ID (TxID):</label>
            <input type="text" id="transactionIdInput" placeholder="Enter your transaction ID" required>
            <button type="submit">Confirm Payment / I've Sent It</button>
        </form>
         <p id="paymentStatusMessage" style="margin-top:15px; text-align:center;"></p>
    </div>
</div>


<!-- Generic JSON Import Modal -->
<div id="genericImportModal" class="modal">
    <div class="modal-content generic-import-modal-content">
        <span class="close-button" onclick="closeGenericImportModal()">&times;</span>
        <h2>Import Portfolio</h2>
        
        <div class="import-section">
            <h3>Import from JSON</h3>
            <p>Paste your portfolio data in the JSON format specified below.</p>
            <form id="genericImportForm" onsubmit="handleGenericImport(event)">
                <label for="jsonImportData">JSON Data:</label>
                <textarea id="jsonImportData" rows="8" placeholder="Paste your JSON here..."></textarea>
                <button type="submit" id="submitJsonImportButton">Import from JSON</button>
            </form>
            <h4>Expected JSON Format:</h4>
            <div id="jsonImportInstructions">
                <pre><code>
{
  "holdings": [
    {
      "symbol": "AAPL",
      "shares": 10,
      "average_cost_price": 150.00,
      "sector": "Technology",      
      "custom_category": "Growth" 
    }
  ],
  "transactions": [
    {
      "symbol": "MSFT",
      "shares": 5,
      "price": 200.00,
      "transaction_type": "buy", 
      "transaction_date": "2023-01-15", 
      "sector": "Technology",         
      "custom_category": "Core Holding" 
    }
  ]
}
                </code></pre>
            </div>
        </div>

        <div class="import-section">
            <h3>Connect to Broker (Coming Soon)</h3>
            <p>Directly connect to your brokerage account to import your portfolio.</p>
            <label for="brokerSelect">Select Broker:</label>
            <select id="brokerSelect">
                <option value="Trading212">Trading212</option>
                <option value="Robinhood">Robinhood</option>
                <option value="InteractiveBrokers">Interactive Brokers</option>
                <option value="CharlesSchwab">Charles Schwab</option>
                <option value="Fidelity">Fidelity</option>
            </select>
            <button id="connectBrokerButton" style="width:auto; margin-top:10px;">Connect</button>
        </div>
    </div>
</div>


<!-- Signup Modal -->
<div id="signupModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeSignupModal()">&times;</span>
        <h2>Sign Up</h2>
        <form id="signupForm" onsubmit="handleSignup(event)">
            <input type="text" id="signupUsername" placeholder="Username" required>
            <input type="email" id="signupEmail" placeholder="Email" required>
            <input type="password" id="signupPassword" placeholder="Password" required>
            <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required>
            <button type="submit">Sign Up</button>
        </form>
        <p>Already have an account? <a href="#" onclick="switchToLogin()">Login here</a></p>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLoginModal()">&times;</span>
        <h2>Login</h2>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="#" onclick="switchToSignup()">Sign up here</a></p>
    </div>
</div>

<!-- Admin Dashboard Modal -->
<div id="adminDashboardModal" class="modal">
    <div class="modal-content admin-modal-content">
        <span class="close-button" onclick="closeAdminDashboardModal()">&times;</span>
        <h2>Admin Dashboard</h2>
        
        <h3>User Statistics</h3>
        <div class="stats-grid">
            <div class="stat-item"><h4>Total Users</h4><p id="adminTotalUsers">0</p></div>
            <div class="stat-item"><h4>Users with Portfolios</h4><p id="adminUsersWithPortfolios">0</p></div>
            <div class="stat-item"><h4>Users with Alerts</h4><p id="adminUsersWithAlerts">0</p></div>
            <div class="stat-item"><h4>Total Stocks Tracked</h4><p id="adminTotalStocks">0</p></div>
            <div class="stat-item"><h4>Total Active Alerts</h4><p id="adminTotalActiveAlerts">0</p></div>
        </div>

        <h3>System Status</h3>
        <div class="stats-grid">
            <div class="stat-item"><h4>Database Status</h4><p id="adminDbStatus">Unknown</p></div>
            <div class="stat-item"><h4>Alpha Vantage API</h4><p id="adminApiStatus">Unknown</p></div>
        </div>
        
        <h3>User List</h3>
        <div id="adminUserListContainer" style="max-height: 300px; overflow-y: auto;">
            <p>Loading user list...</p>
        </div>

        <h3>Pending Crypto Payments</h3>
        <div id="adminPendingPaymentsContainer" style="max-height: 300px; overflow-y: auto;">
            <p>Loading pending payments...</p>
            <!-- Table will be rendered here by renderAdminPendingPayments -->
        </div>
    </div>
</div>


<script nonce="random-nonce-value-for-security-1234567890123456789"> <!-- Updated nonce -->
    // --- DOM Elements ---
    // ... (keep existing DOM elements from previous steps)
    const subscriptionPlansModal = document.getElementById('subscriptionPlansModal'); 
    const subscriptionPlansContainer = document.getElementById('subscriptionPlansContainer'); 
    const paymentMethodSelectionEl = document.getElementById('paymentMethodSelection'); // New
    const selectedPlanNameEl = document.getElementById('selectedPlanName'); // New
    const cryptoPaymentModal = document.getElementById('cryptoPaymentModal'); // New
    const cryptoPaymentTitleEl = document.getElementById('cryptoPaymentTitle'); // New
    const cryptoAmountExpectedEl = document.getElementById('cryptoAmountExpected'); // New
    const cryptoTypeDisplayEl = document.getElementById('cryptoTypeDisplay'); // New
    const cryptoReceivingAddressEl = document.getElementById('cryptoReceivingAddress'); // New
    const cryptoNetworkDisplayEl = document.getElementById('cryptoNetworkDisplay'); // New
    const transactionIdFormEl = document.getElementById('transactionIdForm'); // New
    const cryptoPaymentIdEl = document.getElementById('cryptoPaymentId'); // New (hidden input)
    const transactionIdInputEl = document.getElementById('transactionIdInput'); // New
    const paymentStatusMessageEl = document.getElementById('paymentStatusMessage'); // New
    const adminPendingPaymentsContainerEl = document.getElementById('adminPendingPaymentsContainer'); // New


    let currentSelectedPlanId = null; // To store plan_id when user clicks "Choose Plan"

    // ... (keep existing modal control functions)
    function openSubscriptionPlansModal() { 
        subscriptionPlansModal.style.display = 'block'; 
        paymentMethodSelectionEl.style.display = 'none'; // Hide payment options initially
        cryptoPaymentModal.style.display = 'none'; // Ensure crypto payment modal is hidden
        fetchAndRenderSubscriptionPlans();
    }
    function closeSubscriptionPlansModal() { subscriptionPlansModal.style.display = 'none'; }

    function openCryptoPaymentModal() { cryptoPaymentModal.style.display = 'block'; }
    function closeCryptoPaymentModal() { 
        cryptoPaymentModal.style.display = 'none'; 
        clearForm('transactionIdForm');
        paymentStatusMessageEl.textContent = ''; // Clear any status messages
    }


    window.onclick = function(event) {
        // ... (keep existing window.onclick logic)
        if (event.target == subscriptionPlansModal) closeSubscriptionPlansModal(); 
        if (event.target == cryptoPaymentModal) closeCryptoPaymentModal(); // New
    }

    // ... (keep existing API Helper, Auth, Portfolio, Alerts, Dividends, News functions)

    // --- Subscription Plan Display & Payment Initiation ---
    async function fetchAndRenderSubscriptionPlans() {
        subscriptionPlansContainer.innerHTML = '<p>Loading plans...</p>';
        try {
            const plans = await fetchAPI('/api/subscription-plans', {requiresAuth: false}); 
            if (plans && plans.length > 0) {
                renderSubscriptionPlans(plans);
            } else {
                subscriptionPlansContainer.innerHTML = '<p>No subscription plans available at this time.</p>';
            }
        } catch (error) {
            subscriptionPlansContainer.innerHTML = '<p>Could not load subscription plans.</p>';
        }
    }
    
    function renderSubscriptionPlans(plans) {
        subscriptionPlansContainer.innerHTML = '';
        plans.forEach(plan => {
            const planCard = document.createElement('div');
            planCard.className = 'plan-card';
            
            let featuresHTML = '<ul>';
            featuresHTML += `<li>Max Stocks: ${plan.max_stocks === null ? 'Unlimited' : plan.max_stocks}</li>`;
            featuresHTML += `<li class="${plan.allow_custom_categories ? '' : 'not-included'}">Custom Categories</li>`;
            featuresHTML += `<li class="${plan.allow_dividend_tracking ? '' : 'not-included'}">Dividend Tracking</li>`;
            featuresHTML += `<li class="${plan.allow_benchmarking ? '' : 'not-included'}">Portfolio Benchmarking</li>`;
            featuresHTML += `<li class="${plan.allow_csv_import ? '' : 'not-included'}">CSV Import</li>`;
            featuresHTML += `<li class="${plan.allow_generic_import ? '' : 'not-included'}">Generic JSON Import</li>`;
            featuresHTML += `<li class="${plan.allow_api_access ? '' : 'not-included'}">API Access</li>`;
            featuresHTML += '</ul>';

            planCard.innerHTML = `
                <h3>${plan.name}</h3>
                <p class="price">$${plan.price_monthly.toFixed(2)}/month</p>
                ${featuresHTML}
                <button onclick="handleChoosePlan(${plan.id}, '${plan.name}')">Choose Plan</button>
            `;
            subscriptionPlansContainer.appendChild(planCard);
        });
    }

    function handleChoosePlan(planId, planName) {
        currentSelectedPlanId = planId;
        selectedPlanNameEl.textContent = planName;
        paymentMethodSelectionEl.style.display = 'block'; // Show payment options
        // Hide the plan cards or the entire container if preferred, to focus on payment
        // subscriptionPlansContainer.style.display = 'none'; 
    }

    async function initiateCryptoPaymentFlow() {
        if (!currentSelectedPlanId) {
            showNotification('Please select a plan first.', 'error');
            return;
        }
        
        const cryptoType = "USDT-TRC20"; // Hardcoded for now as per requirement
        
        try {
            const paymentInitData = await fetchAPI('/api/payments/initiate', {
                method: 'POST',
                body: { plan_id: currentSelectedPlanId, crypto_type: cryptoType }
            });

            if (paymentInitData) {
                cryptoPaymentTitleEl.textContent = `Pay for ${paymentInitData.plan_name} with Crypto`;
                cryptoAmountExpectedEl.textContent = paymentInitData.amount_expected_usd.toFixed(2);
                cryptoTypeDisplayEl.textContent = paymentInitData.crypto_type;
                cryptoReceivingAddressEl.textContent = paymentInitData.receiving_address;
                // Assuming network based on crypto_type for display
                if (paymentInitData.crypto_type.toUpperCase().includes("TRC20")) {
                    cryptoNetworkDisplayEl.textContent = "TRC-20 (Tron)";
                } else if (paymentInitData.crypto_type.toUpperCase() === "BTC") {
                     cryptoNetworkDisplayEl.textContent = "Bitcoin (BTC)";
                } else {
                     cryptoNetworkDisplayEl.textContent = "N/A";
                }
                cryptoPaymentIdEl.value = paymentInitData.payment_id;
                paymentStatusMessageEl.textContent = ''; // Clear previous messages
                
                closeSubscriptionPlansModal(); // Close plans modal
                openCryptoPaymentModal(); // Open crypto payment instructions modal
            }
        } catch (error) {
            // fetchAPI already shows notification
            console.error("Error initiating crypto payment:", error);
        }
    }

    async function handleTransactionIdSubmit(event) {
        event.preventDefault();
        const paymentId = cryptoPaymentIdEl.value;
        const transactionId = transactionIdInputEl.value.trim();

        if (!transactionId) {
            showNotification('Please enter your Transaction ID.', 'error');
            return;
        }

        try {
            const result = await fetchAPI(`/api/payments/${paymentId}/submit_txid`, {
                method: 'POST',
                body: { transaction_id: transactionId }
            });
            if (result) {
                showNotification(result.message || 'Transaction ID submitted. Payment is pending admin review.', 'success');
                paymentStatusMessageEl.textContent = 'Transaction ID submitted. Awaiting admin confirmation.';
                transactionIdFormEl.style.display = 'none'; // Hide form after submission
                // Optionally, close the modal after a delay or keep it open with the message
                // setTimeout(closeCryptoPaymentModal, 3000);
            }
        } catch (error) {
            // fetchAPI shows error
            paymentStatusMessageEl.textContent = 'Error submitting Transaction ID. Please try again.';
        }
    }


    // --- Admin Dashboard Logic ---
    async function openAdminDashboard() {
        // ... (existing logic) ...
        fetchAndRenderPendingPayments(); // Fetch pending payments when admin dashboard opens
    }

    async function fetchAndRenderPendingPayments() {
        adminPendingPaymentsContainerEl.innerHTML = '<p>Loading pending payments...</p>';
        try {
            const payments = await fetchAPI('/api/admin/payments/pending');
            if (payments && payments.length > 0) {
                renderAdminPendingPayments(payments);
            } else {
                adminPendingPaymentsContainerEl.innerHTML = '<p>No payments are currently pending review.</p>';
            }
        } catch (error) {
            adminPendingPaymentsContainerEl.innerHTML = '<p>Could not load pending payments.</p>';
        }
    }

    function renderAdminPendingPayments(payments) {
        adminPendingPaymentsContainerEl.innerHTML = '';
        const table = document.createElement('table');
        table.style.width = '100%';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User Email</th>
                    <th>Plan</th>
                    <th>Amount (USD)</th>
                    <th>Crypto Type</th>
                    <th>User TxID</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        payments.forEach(p => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${p.id}</td>
                <td>${p.user_email}</td>
                <td>${p.plan_name}</td>
                <td>${p.amount_expected_usd.toFixed(2)}</td>
                <td>${p.crypto_type}</td>
                <td style="word-break:break-all;">${p.user_provided_tx_id || 'N/A'}</td>
                <td>${new Date(p.updated_at).toLocaleDateString()}</td>
                <td>
                    <button class="action-button edit-button" onclick="handleAdminConfirmPayment(${p.id})" title="Confirm Payment">✓ Confirm</button>
                    <button class="action-button delete-button" onclick="handleAdminFailPayment(${p.id})" title="Mark as Failed">✗ Fail</button>
                </td>
            `;
        });
        adminPendingPaymentsContainerEl.appendChild(table);
    }

    async function handleAdminConfirmPayment(paymentId) {
        if (!confirm(`Are you sure you want to confirm payment ID ${paymentId}? This will update the user's subscription.`)) return;
        try {
            await fetchAPI(`/api/admin/payments/${paymentId}/confirm`, { method: 'POST' });
            showNotification('Payment confirmed and subscription updated!', 'success');
            fetchAndRenderPendingPayments(); // Refresh list
            fetchUserSubscription(); // If admin is also the user being updated, refresh their view
        } catch (error) { /* Handled by fetchAPI */ }
    }

    async function handleAdminFailPayment(paymentId) {
        if (!confirm(`Are you sure you want to mark payment ID ${paymentId} as FAILED?`)) return;
        try {
            await fetchAPI(`/api/admin/payments/${paymentId}/fail`, { method: 'POST' });
            showNotification('Payment marked as failed.', 'success');
            fetchAndRenderPendingPayments(); // Refresh list
        } catch (error) { /* Handled by fetchAPI */ }
    }


    // --- UI Updates & Data Rendering ---
    // ... (keep existing functions like updateUIForLoggedInUser, updateUIForLoggedOutUser, etc.)
    // ... (ensure applyFeatureGating is called appropriately after subscription updates)

    async function updateUIForLoggedInUser() { 
        loginNavButton.style.display = 'none';
        signupNavButton.style.display = 'none';
        logoutButton.style.display = 'block';
        viewPlansButton.style.display = 'inline-block'; 
        stockDashboard.style.display = 'block';
        
        if (localStorage.getItem('isAdmin') === 'true') {
            adminDashboardLink.style.display = 'inline-block';
        } else {
            adminDashboardLink.style.display = 'none';
        }

        generateLetterFilters();
        await fetchUserSubscription(); 
        await fetchAndRenderPortfolio(); 
        fetchAndRenderNews(); 
        fetchAndRenderAlerts(); 
        
        initPortfolioPerformanceChart(currentPerformancePeriod); 
        initAllocationChart(); 
        initSectorAnalysisChart();
        initDividendChart(); 
    }
    
    // ... (rest of the file)

</script>
</body>
</html>
